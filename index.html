<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>服務商網路平台 | Service Provider Portal</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --deep-orange:#ff6403;
      --ink-blue:#161d26;
      --border-light:#e5e7eb;
      --site-pill-bg:rgba(255,255,255,.08);
      --site-pill-border:rgba(255,255,255,.4);
    }
    body{
      background:#f8f9fa;
      font-family:'PingFang TC','Microsoft JhengHei',sans-serif;
    }

    /* ========= NAV (Black Bar) ========= */
    .headbar{background:#000;color:#fff;padding:8px 0;}
    .headbar .brand-title{font-weight:700;font-size:1.1rem;}

    .search-box{
      background:#fff;border-radius:8px;overflow:hidden;
      display:flex;align-items:center;border:1px solid #2b3542;
    }
    .search-box input{
      border:0;padding:.55rem .8rem;flex:1;min-width:220px;
    }
    .search-box .btn-search{
      background:var(--deep-orange);color:#fff;border:0;
      width:44px;display:flex;align-items:center;justify-content:center;
    }

    /* ========= HERO ========= */
    .hero-section{
      background:linear-gradient(135deg,#232f3e,#37475a);
      color:white;padding:3rem 0 2.7rem;
    }
    .hero-section h1{font-size:2.2rem;font-weight:700;}
    .hero-section p{opacity:.9;font-size:1.05rem;}

    .hero-stats{
      background:rgba(255,255,255,.08);
      padding:1.3rem;border-radius:10px;margin-top:1.2rem;
    }

    .site-filter-bar{
      margin-top:1.2rem;
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:.4rem;
      font-size:.8rem;
    }
    .site-filter{
      border-radius:999px;
      border:1px solid var(--site-pill-border);
      background:var(--site-pill-bg);
      color:#f9fafb;
      padding:.25rem .75rem;
      cursor:pointer;
    }
    .site-filter.active{
      background:#ffd814;
      color:#111827;
      border-color:#ffd814;
      font-weight:600;
    }

    /* ========= Categories ========= */
    .category-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:1rem;margin-top:2rem;
    }
    .category-card{
      background:#fff;border-radius:8px;
      padding:1rem;border:1px solid #e5e7eb;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      cursor:pointer;transition:.15s;
    }
    .category-card:hover{
      transform:translateY(-3px);
      box-shadow:0 4px 14px rgba(0,0,0,.12);
      border-color:#ff9900;
    }
    .category-icon{
      background:#ff9900;color:#fff;border-radius:8px;
      width:40px;height:40px;display:flex;align-items:center;
      justify-content:center;font-size:1.2rem;margin-bottom:.5rem;
    }

    /* ========= Providers List ========= */
    .provider-card{
      background:#fff;border:1px solid #e5e7eb;border-radius:10px;
      padding:1rem;cursor:pointer;transition:.2s;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .provider-card:hover{
      transform:translateY(-3px);
      box-shadow:0 6px 16px rgba(0,0,0,.1);
    }

    /* ========= Detail Page ========= */
    .detail-card{
      background:white;border-radius:12px;
      border:1px solid #e5e7eb;padding:2rem;
      box-shadow:0 3px 12px rgba(0,0,0,.06);
    }
  </style>
</head>

<body>

<!-- ========= NAV ========= -->
<nav class="headbar">
  <div class="container d-flex align-items-center justify-content-between">
    <div class="brand-title">Service Provider Portal</div>

    <form id="searchForm" class="d-flex" style="max-width:360px;width:100%;">
      <div class="search-box flex-grow-1">
        <input id="searchInput" type="search" placeholder="搜尋公司名稱、服務、介紹..." />
        <button class="btn-search" type="submit"><i class="bi bi-search"></i></button>
      </div>
    </form>
  </div>
</nav>

<!-- ========= HERO ========= -->
<section class="hero-section text-center">
  <div class="container">
    <h1>服務商網路平台</h1>
    <p>依據服務類型與站點，快速找到合適的服務供應商</p>

    <div class="hero-stats row">
      <div class="col-6 text-center">
        <div id="statProviders" class="h2 mb-0">0</div>
        <small>服務商數量</small>
      </div>
      <div class="col-6 text-center">
        <div id="statTypes" class="h2 mb-0">0</div>
        <small>服務類型</small>
      </div>
    </div>

    <!-- 站點選擇 -->
    <div class="site-filter-bar">
      <span class="me-1">目標站點：</span>
      <button class="site-filter active" data-site="">全部</button>
      <button class="site-filter" data-site="北美站">北美站</button>
      <button class="site-filter" data-site="歐洲站">歐洲站</button>
      <button class="site-filter" data-site="日本站">日本站</button>
      <button class="site-filter" data-site="澳洲/新加坡">澳洲/新加坡</button>
      <button class="site-filter" data-site="中東站">中東站</button>
    </div>
  </div>
</section>

<!-- ========= LEVEL 1: Categories ========= -->
<section id="level1" class="py-4">
  <div class="container">
    <h3 class="text-center mb-3">選擇服務類型</h3>
    <div id="serviceCategories" class="category-grid"></div>
  </div>
</section>

<!-- ========= LEVEL 2: Provider List ========= -->
<section id="level2" style="display:none;">
  <div class="container py-4">
    <button class="btn btn-outline-primary mb-3" onclick="showLevel1()">
      <i class="bi bi-arrow-left"></i> 返回
    </button>

    <h3 id="level2Title" class="mb-3"></h3>

    <nav id="subTypeNav" class="nav nav-pills mb-3 gap-2"></nav>

    <div id="providersList" class="row g-3"></div>
  </div>
</section>

<!-- ========= LEVEL 3: Detail Page ========= -->
<section id="level3" style="display:none;">
  <div class="container py-4">
    <button class="btn btn-outline-primary mb-3" onclick="showLevel2()">
      <i class="bi bi-arrow-left"></i> 返回
    </button>

    <div id="providerDetail"></div>
  </div>
</section>

<footer class="text-center py-3 text-muted">
  © 2025 Service Provider Portal
</footer>

<!-- JS libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* ========== 全域變數 ========== */
let providers = [];
let providerMap = {};
let categories = [];
let categoryMap = {};
let currentCategory = null;
let currentSubType = null;
let currentSite = null;         // 目前選擇的站點（null = 全部）
let lastSearchQuery = '';       // 上次搜尋字串

/* ========== DOM 參考 ========== */
const level1 = document.getElementById("level1");
const level2 = document.getElementById("level2");
const level3 = document.getElementById("level3");
const statProviders = document.getElementById("statProviders");
const statTypes = document.getElementById("statTypes");
const serviceCategories = document.getElementById("serviceCategories");
const providersList = document.getElementById("providersList");
const level2Title = document.getElementById("level2Title");
const subTypeNav = document.getElementById("subTypeNav");
const providerDetail = document.getElementById("providerDetail");

/* ========== 工具 ==========
   truthyFlag：判斷站點欄位是否為有效值 (Y / 是 / True / 1 都會算)
================================= */
function truthyFlag(v){
  if(v === undefined || v === null) return false;
  const s = String(v).trim().toLowerCase();
  if(!s) return false;
  return !["0","n","no","false","未提供","x"].includes(s);
}

/* 判斷此 provider 是否符合目前站點 */
function matchesSite(p){
  if(!currentSite) return true;              // 未選站點 = 不過濾
  if(!p.regions || !p.regions.length) return false;
  return p.regions.includes(currentSite);
}

/* 切換頁面：首頁 */
function showLevel1(){
  level1.style.display = "block";
  level2.style.display = "none";
  level3.style.display = "none";
  currentCategory = null;
}

/* 切換頁面：服務商列表 */
function showLevel2(){
  level1.style.display = "none";
  level2.style.display = "block";
  level3.style.display = "none";
}

/* 切換頁面：詳細資料 */
function showLevel3(){
  level1.style.display = "none";
  level2.style.display = "none";
  level3.style.display = "block";
}

/* ============================================
   變更站點（全域 filter）
============================================ */
function setSite(site){
  currentSite = site || null;

  // 更新 UI
  document.querySelectorAll(".site-filter").forEach(btn=>{
    const s = btn.getAttribute("data-site") || "";
    btn.classList.toggle("active", s === (site || ""));
  });

  // 依目前頁面與狀態重新渲染
  if(level3.style.display === "block"){
    // 詳細頁就先不動（或依需求再調整）
    return;
  }

  if(level2.style.display === "block"){
    // 在列表頁：可能是分類或搜尋結果
    if(level2Title.textContent.startsWith("搜尋結果：") && lastSearchQuery){
      runSearch(true);   // true 表示從 setSite 呼叫（但目前沒特別用）
    }else if(currentCategory){
      if(currentSubType){
        renderProviderList(filterBySubType(currentSubType));
      }else{
        renderProviderList(filterByCategoryOnly(currentCategory.name));
      }
    }
  }else{
    // 在首頁，只需要等使用者做下一步（點分類或搜尋）
    return;
  }
}

/* ============================================
   渲染「分類卡片」(Level 1)
============================================ */
function renderCategories(){
  serviceCategories.innerHTML = categories.map(cat => `
    <div class="category-card" data-cat="${cat.name}">
      <div class="category-icon"><i class="bi bi-layers"></i></div>
      <div class="fw-bold">${cat.name}</div>
      <div class="text-muted" style="font-size:.85rem;">
        ${cat.subTypes.slice(0,3).join("、")}
      </div>
    </div>
  `).join("");

  document.querySelectorAll(".category-card").forEach(card => {
    card.addEventListener("click", () => {
      goToCategory(card.dataset.cat);
    });
  });
}

/* ============================================
   進入某一大類 (Level 2)
============================================ */
function goToCategory(name){
  currentCategory = categoryMap[name];
  currentSubType = null;
  lastSearchQuery = '';    // 清除搜尋狀態

  level2Title.textContent = `${name} 服務商`;
  showLevel2();

  // 生成子類 (subTypes) tabs
  subTypeNav.innerHTML = "";
  if(currentCategory.subTypes.length){
    currentCategory.subTypes.forEach((sub, idx)=>{
      const tab = document.createElement("button");
      tab.className = "nav-link" + (idx===0 ? " active" : "");
      tab.textContent = sub;
      tab.addEventListener("click", ()=>{
        document.querySelectorAll("#subTypeNav .nav-link").forEach(x=>x.classList.remove("active"));
        tab.classList.add("active");
        currentSubType = sub;
        renderProviderList(filterBySubType(sub));
      });
      subTypeNav.appendChild(tab);
    });
    currentSubType = currentCategory.subTypes[0];
    renderProviderList(filterBySubType(currentSubType));
  } else {
    renderProviderList(filterByCategoryOnly(name));
  }
}

/* 子類過濾 */
function filterBySubType(sub){
  return providers.filter(p =>
    matchesSite(p) &&
    p.tags.includes(sub)
  );
}

/* 沒子類時 */
function filterByCategoryOnly(cat){
  const c = categoryMap[cat];
  if(!c || !c.subTypes.length){
    return providers.filter(p => matchesSite(p));
  }
  return providers.filter(p =>
    matchesSite(p) &&
    p.tags.some(t => c.subTypes.includes(t))
  );
}

/* ============================================
   渲染「服務商列表」
============================================ */
function renderProviderList(list){
  if(!list.length){
    providersList.innerHTML = `<div class="col-12 text-muted">目前無符合條件的服務商。</div>`;
    return;
  }
  providersList.innerHTML = list.map(p => `
    <div class="col-12 col-md-6">
      <div class="provider-card" data-name="${p.name}">
        <h5>${p.name}</h5>
        <div class="text-danger mb-1">${p.tags.join("、")}</div>
        <p class="text-muted small">
          ${p.description ? (p.description.length>100 ? p.description.slice(0,100)+"…" : p.description) : ""}
        </p>
        <div>
          <small class="text-primary">${p.regions.join("、")}</small>
        </div>
      </div>
    </div>
  `).join("");

  document.querySelectorAll(".provider-card").forEach(card=>{
    card.addEventListener("click",()=>{
      openProviderDetail(card.dataset.name);
    });
  });
}

/* ============================================
   列出詳細資訊 (Level 3)
============================================ */
function openProviderDetail(name){
  const p = providerMap[name];
  if(!p) return;
  showLevel3();

  const servicesHTML = p.services.map(s =>
    `<li><i class="bi bi-check-circle text-success me-2"></i>${s}</li>`
  ).join("");

  providerDetail.innerHTML = `
    <div class="detail-card">
      <h2>${p.name}</h2>
      <p class="text-muted">${p.description || ""}</p>

      <hr>

      <h5>聯絡資訊</h5>
      <p><strong>聯絡人：</strong>${p.contact || "未提供"}</p>
      <p><strong>電話：</strong>${p.phone || "未提供"}</p>
      <p><strong>Email：</strong>${p.email || "未提供"}</p>
      <p><strong>Line：</strong>${p.lineId || "未提供"}</p>

      <h5 class="mt-4">可服務站點</h5>
      <p>${p.regions.join("、") || "未標註"}</p>

      ${servicesHTML ? `
        <h5 class="mt-4">服務內容</h5>
        <ul>${servicesHTML}</ul>
      ` : ""}

      ${p.website ? `
        <h5 class="mt-4">官網</h5>
        <p><a href="${p.website}" target="_blank">${p.website}</a></p>
      ` : ""}
    </div>
  `;
}

/* ============================================
   搜尋功能
============================================ */
function runSearch(fromSiteChange){
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  lastSearchQuery = q;

  if(!q){
    showLevel1();
    return;
  }

  showLevel2();
  level2Title.textContent = `搜尋結果：「${q}」`;
  subTypeNav.innerHTML = "";

  const list = providers.filter(p=>{
    if(!matchesSite(p)) return false;
    const hay = [
      p.name, p.description,
      p.tags.join(" "),
      p.services.join(" ")
    ].join(" ").toLowerCase();
    return hay.includes(q);
  });

  renderProviderList(list);
}

/* ============================================
   解析 providers.csv（自動偵測欄位名稱）
============================================ */
function loadProviders(){
  Papa.parse("providers.csv",{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:(res)=>{
      const rows = res.data || [];
      if(!rows.length) return;

      const headers = Object.keys(rows[0]);

      const nameKey  = headers.find(h => /公司名稱|公司|Name/i.test(h)) || headers[0];
      const contactKey = headers.find(h => /聯絡|Contact/i.test(h));
      const phoneKey   = headers.find(h => /電話|Phone/i.test(h));
      const emailKey   = headers.find(h => /email/i.test(h));
      const lineKey    = headers.find(h => /line/i.test(h));
      const logoKey    = headers.find(h => /logo/i.test(h));
      const descKey    = headers.find(h => /介紹|Description/i.test(h));
      const webKey     = headers.find(h => /官網|Website/i.test(h));
      const typeKey    = headers.find(h => /服務類型|類別|Type|Tag/i.test(h));
      const svc1Key    = headers.find(h => /服務內容1/i.test(h));
      const svc2Key    = headers.find(h => /服務內容2/i.test(h));
      const svc3Key    = headers.find(h => /服務內容3/i.test(h));

      providers = rows.map(r=>{
        const name = (r[nameKey] || "").toString().trim();
        if(!name) return null;

        const tags = (r[typeKey] || "")
          .toString()
          .split(/[、,，;；\/]/)
          .map(s=>s.trim()).filter(Boolean);

        const regions = [];
        if(truthyFlag(r["北美站"])) regions.push("北美站");
        if(truthyFlag(r["歐洲站"])) regions.push("歐洲站");
        if(truthyFlag(r["日本站"])) regions.push("日本站");
        if(truthyFlag(r["澳洲/新加坡"])) regions.push("澳洲/新加坡");
        if(truthyFlag(r["中東站"])) regions.push("中東站");

        return {
          name,
          contact: contactKey ? (r[contactKey] || "") : "",
          phone:   phoneKey   ? (r[phoneKey]   || "") : "",
          email:   emailKey   ? (r[emailKey]   || "") : "",
          lineId:  lineKey    ? (r[lineKey]    || "") : "",
          logo:    logoKey    ? (r[logoKey]    || "") : "",
          description: descKey ? (r[descKey]   || "") : "",
          website: webKey     ? (r[webKey]     || "") : "",
          tags,
          services: [svc1Key && r[svc1Key], svc2Key && r[svc2Key], svc3Key && r[svc3Key]]
                      .filter(x=>x && String(x).trim()),
          regions
        };
      }).filter(Boolean);

      providers.forEach(p=>providerMap[p.name] = p);
      statProviders.textContent = providers.length;
    },
    error:(err)=>console.error("providers.csv 讀取失敗",err)
  });
}

/* ============================================
   解析 hierarchy.csv（服務類型階層）
============================================ */
function loadHierarchy(){
  Papa.parse("hierarchy.csv",{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:(res)=>{
      const rows = res.data || [];
      const map = new Map();

      rows.forEach(r=>{
        const vals = Object.values(r).map(v=>String(v||"").trim());
        const parent = vals[0];
        if(!parent) return;
        if(!map.has(parent)) map.set(parent,new Set());
        vals.slice(1).forEach(v=>{ if(v) map.get(parent).add(v); });
      });

      categories = Array.from(map.keys()).map(k=>({
        name:k,
        subTypes:Array.from(map.get(k))
      }));

      categories.forEach(c=>categoryMap[c.name] = c);

      statTypes.textContent = categories.length;
      renderCategories();
    },
    error:(err)=>console.error("hierarchy.csv 讀取失敗",err)
  });
}

/* ============================================
   網站初始化
============================================ */
document.addEventListener("DOMContentLoaded",()=>{

  // 搜尋
  document.getElementById("searchForm")
    .addEventListener("submit",e=>{
      e.preventDefault();
      runSearch(false);
    });

  // 站點按鈕
  document.querySelectorAll(".site-filter").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const site = btn.getAttribute("data-site") || "";
      setSite(site);   // 更新 currentSite + 重新渲染
    });
  });

  // 初始站點 = 全部（currentSite = null）
  setSite("");

  // 讀取 CSV
  loadProviders();
  loadHierarchy();
});
</script>

</body>
</html>
