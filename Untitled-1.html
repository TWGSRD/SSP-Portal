<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æœå‹™å•†æŸ¥è©¢ Portalï¼ˆSPN é¢¨æ ¼ï¼‰</title>
  <style>
    :root{
      --brand:#146eb4;         /* ä¸»è‰²ï¼šè— */
      --brand-dark:#0d3252;    /* æ·±è— */
      --accent:#ff9900;        /* æ©˜è‰²é»ç¶´ */
      --muted:#5f6b7a;
      --bg:#f3f4f8;
      --card-bg:#fff;
      --border:#e1e4ec;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
      color:#111827;
      background:var(--bg);
    }
    a{color:var(--brand);text-decoration:none;}
    a:hover{text-decoration:underline;}

    /* é ‚éƒ¨ NAV */
    .nav{
      height:54px;
      padding:0 32px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:#ffffffee;
      border-bottom:1px solid #e5e7eb;
      backdrop-filter:blur(6px);
      position:sticky;
      top:0;
      z-index:20;
    }
    .nav-left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .nav-logo{
      width:28px;height:28px;
      border-radius:6px;
      background:linear-gradient(135deg,var(--brand) 0%,var(--accent) 100%);
    }
    .nav-title{
      font-weight:600;
      font-size:15px;
    }
    .nav-sub{
      font-size:12px;
      color:var(--muted);
    }

    /* HERO */
    .hero{
      padding:24px 32px 16px;
      background:radial-gradient(circle at top left,#e0edf8 0,#f9fafb 55%);
      border-bottom:1px solid #e5e7eb;
    }
    .hero-inner{
      max-width:1080px;
      margin:0 auto;
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      gap:18px;
    }
    .hero-main{
      flex:1 1 260px;
    }
    .hero-kpi{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      font-size:13px;
      color:var(--muted);
    }
    .badge-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:#e5f2ff;
      color:var(--brand-dark);
      margin-bottom:6px;
    }
    .hero h1{
      margin:2px 0 8px;
      font-size:22px;
      color:var(--brand-dark);
    }
    .hero-desc{
      font-size:13px;
      color:var(--muted);
      max-width:520px;
    }

    .hero-note{
      margin-top:10px;
      font-size:11px;
      color:var(--muted);
    }

    /* ä¸»å€åŸŸ */
    .page{
      max-width:1080px;
      margin:0 auto;
      padding:12px 32px 28px;
    }

    /* Filter Bar */
    .filter-bar{
      margin-top:6px;
      padding:10px 12px;
      border-radius:12px;
      background:#fff;
      border:1px solid var(--border);
      box-shadow:0 10px 30px rgba(15,23,42,0.04);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }
    .filter-group{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
      color:var(--muted);
      min-width:120px;
    }
    .filter-group input,
    .filter-group select{
      padding:7px 8px;
      border-radius:999px;
      border:1px solid #d1d5db;
      font-size:12px;
      background:#f9fafb;
    }
    .filter-group select[multiple]{
      border-radius:10px;
      min-height:80px;
      background:#fff;
    }
    .filter-actions{
      display:flex;
      gap:8px;
      margin-left:auto;
    }
    .btn-primary{
      background:var(--brand);
      color:#fff;
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-primary:hover{
      background:#0f5a95;
    }
    .btn-ghost{
      border-radius:999px;
      border:none;
      background:transparent;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
    }
    .count{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
      padding-left:4px;
    }

    /* Regions pills */
    .regions{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .regions label{
      font-size:11px;
      border-radius:999px;
      border:1px solid #d1d5db;
      padding:3px 8px;
      background:#f9fafb;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .regions input{margin:0;}

    /* Cards */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:12px;
      margin-top:12px;
    }
    .card{
      background:var(--card-bg);
      border-radius:14px;
      padding:12px;
      border:1px solid #e3e6f0;
      box-shadow:0 12px 35px rgba(15,23,42,0.06);
      cursor:pointer;
      transition:transform .12s, box-shadow .12s;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .card:hover{
      transform:translateY(-3px);
      box-shadow:0 18px 45px rgba(15,23,42,0.09);
    }
    .card-header{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:48px;height:48px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      object-fit:contain;
    }
    .card-title{
      font-weight:600;
      font-size:14px;
    }
    .card-sub{
      font-size:12px;
      color:var(--muted);
    }
    .card-tags{
      margin-top:2px;
    }
    .tag{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      font-size:11px;
      margin-right:4px;
      margin-top:4px;
      background:#f9fafb;
    }
    .tag-region{
      border-color:rgba(250,204,21,0.5);
      background:rgba(254,243,199,0.6);
      color:#92400e;
    }
    .card-desc{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .card-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
    }
    .link-small{
      font-size:11px;
      color:var(--brand);
    }
    .btn-link{
      border:none;
      background:transparent;
      color:var(--brand);
      font-size:11px;
      cursor:pointer;
    }

    .empty{
      margin-top:16px;
      padding:18px;
      border-radius:12px;
      background:#fff;
      border:1px dashed #d1d5db;
      text-align:center;
      font-size:13px;
      color:var(--muted);
    }

    /* Modal */
    .modal-bg{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal{
      background:#fff;
      border-radius:16px;
      max-width:820px;
      width:94%;
      max-height:90vh;
      overflow:auto;
      padding:18px 18px 14px;
      box-shadow:0 24px 70px rgba(15,23,42,0.35);
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size:18px;
      cursor:pointer;
      color:#6b7280;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .modal-main{
      margin-top:10px;
      font-size:13px;
    }
    .section-title{
      font-weight:600;
      margin-top:10px;
    }
    .muted{color:var(--muted);}
    .meta-line{margin-top:4px;}
    @media (max-width:720px){
      .hero{padding:16px;}
      .page{padding:12px 16px 24px;}
      .filter-bar{flex-direction:column;align-items:stretch;}
      .filter-actions{margin-left:0;justify-content:flex-end;}
    }
  </style>

  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <div class="nav">
    <div class="nav-left">
      <div class="nav-logo"></div>
      <div>
        <div class="nav-title">Service Provider Finder</div>
        <div class="nav-sub">ç”± Google Sheets é©…å‹•çš„æœå‹™å•†æŸ¥è©¢å…¥å£</div>
      </div>
    </div>
    <div class="nav-sub">è³‡æ–™æ¯æ—¥ç”±å…§éƒ¨ç¶­è­· Â· å°å¤–åƒ…ä¾›æŸ¥è©¢</div>
  </div>

  <section class="hero">
    <div class="hero-inner">
      <div class="hero-main">
        <div class="badge-pill">
          <span>æœå‹™å•†æœå°‹</span>
          <span>Â·</span>
          <span>å¤šæ¢ä»¶ç¯©é¸</span>
        </div>
        <h1>ä¾æœå‹™ç¯„ç–‡èˆ‡å¸‚å ´ï¼Œå¿«é€Ÿæ‰¾åˆ°åˆä½œæœå‹™å•†</h1>
        <div class="hero-desc">
          æœ¬é è³‡æ–™ä¾†æºç‚ºå…§éƒ¨ç¶­è­·çš„ Google è©¦ç®—è¡¨ï¼Œæ”¯æ´ä¾æœå‹™å¤§é¡ã€å­é¡ã€å€åŸŸã€æ¨™ç±¤ä»¥åŠé—œéµå­—é€²è¡Œäº¤å‰æœå°‹ï¼Œ
          å”åŠ©ä½ å¿«é€Ÿæ‰¾åˆ°é©åˆçš„å¤¥ä¼´ã€‚
        </div>
        <div class="hero-kpi" style="margin-top:10px;">
          <div>â€¢ ä¸éœ€è¦ç™»å…¥æˆ–ä¸Šå‚³æª”æ¡ˆï¼Œç›´æ¥æŸ¥è©¢</div>
          <div>â€¢ ç”±ç‡Ÿé‹åœ˜éšŠå®šæœŸæ›´æ–°æœå‹™å•†è³‡è¨Š</div>
        </div>
        <div class="hero-note">
          è‹¥è³‡è¨Šéœ€æ›´æ–°ï¼Œè«‹è¯ç¹«å…§éƒ¨çª—å£ç”±å¾Œå° Google Sheets èª¿æ•´ï¼Œå‰å°å°‡è‡ªå‹•åŒæ­¥ã€‚
        </div>
      </div>
    </div>
  </section>

  <section class="page">
    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-group" style="min-width:180px;">
        <span>é—œéµå­—æœå°‹</span>
        <input id="search" placeholder="è¼¸å…¥å…¬å¸åç¨± / æœå‹™é—œéµå­—ï¼ˆEnterï¼‰" />
      </div>
      <div class="filter-group">
        <span>æœå‹™å¤§é¡</span>
        <select id="parentType">
          <option value="">å…¨éƒ¨</option>
        </select>
      </div>
      <div class="filter-group">
        <span>å­é¡</span>
        <select id="childType">
          <option value="">å…¨éƒ¨</option>
        </select>
      </div>
      <div class="filter-group" style="flex:1 1 180px;">
        <span>æœå‹™æ¨™ç±¤ï¼ˆå¤šé¸ï¼‰</span>
        <select id="tags" multiple></select>
      </div>
      <div class="filter-actions">
        <button id="apply" class="btn-primary">
          ğŸ” å¥—ç”¨ç¯©é¸
        </button>
        <button id="reset" class="btn-ghost">é‡è¨­</button>
      </div>
    </div>

    <div class="count" id="count">æ­£åœ¨è®€å–è³‡æ–™...</div>

    <!-- Regions row -->
    <div style="margin-top:6px;font-size:12px;color:var(--muted);">
      å¯æœå‹™å€åŸŸï¼š
      <span id="regions" class="regions"></span>
    </div>

    <!-- Results -->
    <div id="empty" class="empty">æ­£åœ¨è¼‰å…¥æœå‹™å•†è³‡æ–™ï¼Œè«‹ç¨å€™...</div>
    <div id="grid" class="grid"></div>
  </section>

  <!-- è©³ç´°è³‡æ–™ Modal -->
  <div id="modalBg" class="modal-bg">
    <div class="modal" id="modal"></div>
  </div>

<script>
/* ========= 1. è¨­å®šä½ çš„ Google Sheets CSV ä¾†æº ========= */

// ä¸»è³‡æ–™ï¼ˆæœå‹™å•†è³‡è¨Šèˆ‡ tagsï¼‰
const MAIN_CSV_URL =
  'https://docs.google.com/spreadsheets/d/1cQ-mAnSIBrZWjcZUE-TaLEzpQ4zwpaSb-rbITFSSy3o/export?format=csv&gid=0';

// æœå‹™é¡å‹éšå±¤ï¼ˆå¤§é¡ / å­é¡ï¼‰
const HIER_CSV_URL =
  'https://docs.google.com/spreadsheets/d/1qllWvMmRQXHyvTnh9GFFuYsvH7hmDmo4vcZk_wIADMY/export?format=csv&gid=0';

/* ========= 2. Header mapping / å°å·¥å…· ========= */

function normKey(k){
  const s=(k||'').toLowerCase().trim();
  if(!s) return '';
  if(/provider|id/.test(s) && (s.includes('provider')||s.includes('id'))) return 'provider_id';
  if(/å…¬å¸|company|name/.test(s)) return 'name';
  if(/æœå‹™é¡|service/.test(s) && !/éšå±¤/.test(s)) return 'service';
  if(/æœå‹™å…§å®¹|service_content|æœå‹™é …ç›®/.test(s)) return 'service_contents';
  if(/åœ°å€|region|location/.test(s)) return 'region';
  if(/åœ‹å®¶|countries/.test(s)) return 'countries';
  if(/è¯çµ¡|contact/.test(s)) return 'contact';
  if(/email/.test(s)) return 'email';
  if(/line/.test(s)) return 'line';
  if(/é›»è©±|phone/.test(s)) return 'phone';
  if(/logo/.test(s)) return 'logo';
  if(/ä»‹ç´¹|æè¿°|description|about/.test(s)) return 'description';
  if(/å®˜ç¶²|website|url/.test(s)) return 'website';
  if(/ç‹€æ…‹|status/.test(s)) return 'status';
  if(/tag|æ¨™ç±¤|æœå‹™é¡å‹/.test(s)) return 'tags';
  return s.replace(/\s+/g,'_');
}

function detectRegionFields(headers){
  const keywords=['ç«™','åŒ—ç¾','æ­æ´²','æ—¥æœ¬','æ¾³æ´²','æ–°åŠ ','æ–°åŠ å¡','ä¸­æ±','äº'];
  return headers.filter(h=>{
    const s=(h||'').toLowerCase();
    if(keywords.some(k=>s.includes(k))) return true;
    if(s.includes('region') || s.includes('åœ°å€')) return true;
    return false;
  });
}

function normalizeRow(raw){
  const out={};
  Object.keys(raw).forEach(k=>{
    const nk=normKey(k);
    out[nk]=raw[k] && String(raw[k]).trim();
  });
  return out;
}

/* ========= 3. å…¨åŸŸç‹€æ…‹ ========= */

let mainRows=[];          // æœå‹™å•†è³‡æ–™
let hierarchy=[];         // [{parent, child}]
let regionFields=[];      // e.g. åŒ—ç¾ç«™ / æ­æ´²ç«™
let tagSet=new Set();
let parentMap=new Map();
let mainLoaded=false;
let hierLoaded=false;

/* ========= 4. DOM ========= */

const grid       = document.getElementById('grid');
const empty      = document.getElementById('empty');
const countEl    = document.getElementById('count');
const parentSel  = document.getElementById('parentType');
const childSel   = document.getElementById('childType');
const regionsDiv = document.getElementById('regions');
const tagsSel    = document.getElementById('tags');
const searchInput= document.getElementById('search');
const applyBtn   = document.getElementById('apply');
const resetBtn   = document.getElementById('reset');
const modalBg    = document.getElementById('modalBg');
const modal      = document.getElementById('modal');

function setCount(n){
  if(!mainRows.length){
    countEl.textContent='å°šæœªè¼‰å…¥è³‡æ–™';
  }else{
    countEl.textContent=`é¡¯ç¤º ${n} ç­†çµæœï¼ˆç¸½ ${mainRows.length} ç­†ï¼‰`;
  }
}

/* ========= 5. Filter UI å»ºç«‹ ========= */

function buildFiltersFromData(){
  if(!mainRows.length) return;

  // tags
  tagSet.clear();
  mainRows.forEach(r=>{
    ['tags','service','service_contents'].forEach(k=>{
      if(r[k]){
        r[k].split(/[,;\/|ï¼Œã€]/).map(s=>s.trim()).forEach(t=>{ if(t) tagSet.add(t); });
      }
    });
  });

  tagsSel.innerHTML='';
  Array.from(tagSet).sort().forEach(t=>{
    const o=document.createElement('option');
    o.value=t; o.textContent=t;
    tagsSel.appendChild(o);
  });

  // regions
  regionsDiv.innerHTML='';
  regionFields.forEach(f=>{
    const id='rg_'+f.replace(/\s+/g,'_');
    const lab=document.createElement('label');
    lab.innerHTML=`<input type="checkbox" data-field="${f}" id="${id}" /> ${f}`;
    regionsDiv.appendChild(lab);
  });

  // parent / child
  parentSel.innerHTML='<option value="">å…¨éƒ¨</option>';
  childSel.innerHTML='<option value="">å…¨éƒ¨</option>';
  parentMap.clear();
  hierarchy.forEach(row=>{
    const p=row.parent||'';
    (row.child||'').split(/[,ï¼Œ]/).map(x=>x.trim()).forEach(c=>{
      if(!p||!c) return;
      if(!parentMap.has(p)) parentMap.set(p,new Set());
      parentMap.get(p).add(c);
    });
  });
  Array.from(parentMap.keys()).sort().forEach(p=>{
    const o=document.createElement('option');
    o.value=p; o.textContent=p;
    parentSel.appendChild(o);
  });
}

/* ========= 6. Cards rendering ========= */

function renderRows(rows){
  grid.innerHTML='';
  if(!rows || !rows.length){
    empty.style.display='block';
    setCount(0);
    return;
  }
  empty.style.display='none';
  setCount(rows.length);

  rows.forEach(r=>{
    const card=document.createElement('div');
    card.className='card';

    const head=document.createElement('div');
    head.className='card-header';

    if(r.logo){
      const img=document.createElement('img');
      img.src=r.logo;
      img.alt='logo';
      img.className='logo';
      head.appendChild(img);
    }

    const txt=document.createElement('div');
    txt.innerHTML=`
      <div class="card-title">${r.name || r.provider_id || 'æœªå‘½åæœå‹™å•†'}</div>
      <div class="card-sub">${r.service || ''}</div>
    `;
    head.appendChild(txt);
    card.appendChild(head);

    const tagsWrap=document.createElement('div');
    tagsWrap.className='card-tags';

    ['tags','service','service_contents'].forEach(k=>{
      if(r[k]){
        r[k].split(/[,;\/|ï¼Œã€]/).map(s=>s.trim()).filter(Boolean).slice(0,6).forEach(t=>{
          const span=document.createElement('span');
          span.className='tag';
          span.textContent=t;
          tagsWrap.appendChild(span);
        });
      }
    });

    // region tags
    regionFields.forEach(f=>{
      const val=r[f];
      if(val && String(val).trim() && !['0','false','n','no',''].includes(String(val).toLowerCase())){
        const span=document.createElement('span');
        span.className='tag tag-region';
        span.textContent=f;
        tagsWrap.appendChild(span);
      }
    });

    card.appendChild(tagsWrap);

    if(r.description){
      const p=document.createElement('div');
      p.className='card-desc';
      p.textContent = r.description.length>120 ? r.description.slice(0,120)+'â€¦' : r.description;
      card.appendChild(p);
    }

    const footer=document.createElement('div');
    footer.className='card-footer';
    footer.innerHTML=`
      <span>${r.region || ''}</span>
      <span>
        ${r.website ? `<a class="link-small" href="${r.website}" target="_blank">å®˜ç¶²</a> Â· ` : ''}
        <button class="btn-link">æŸ¥çœ‹è©³æƒ… â€º</button>
      </span>
    `;
    footer.querySelector('.btn-link').addEventListener('click',e=>{
      e.stopPropagation();
      openModal(r);
    });
    card.appendChild(footer);

    card.addEventListener('click',()=>openModal(r));
    grid.appendChild(card);
  });
}

/* ========= 7. Modal ========= */

function openModal(r){
  modal.innerHTML='';
  const header=document.createElement('div');
  header.className='modal-header';

  const left=document.createElement('div');
  left.style.display='flex';
  left.style.gap='10px';
  left.style.alignItems='center';

  if(r.logo){
    const img=document.createElement('img');
    img.src=r.logo;
    img.alt='logo';
    img.style.width='56px';
    img.style.height='56px';
    img.style.borderRadius='12px';
    img.style.border='1px solid #e5e7eb';
    img.style.objectFit='contain';
    img.style.background='#f9fafb';
    left.appendChild(img);
  }

  const text=document.createElement('div');
  text.innerHTML=`
    <div style="font-size:18px;font-weight:600;">${r.name || r.provider_id || 'æœªå‘½åæœå‹™å•†'}</div>
    <div class="muted" style="font-size:13px;margin-top:4px;">${r.service || ''}</div>
  `;
  left.appendChild(text);
  header.appendChild(left);

  const right=document.createElement('div');
  right.innerHTML='<button class="modal-close">âœ•</button>';
  header.appendChild(right);
  modal.appendChild(header);

  const main=document.createElement('div');
  main.className='modal-main';
  main.innerHTML=`
    <div class="section-title">å…¬å¸ä»‹ç´¹</div>
    <div class="muted meta-line">${r.description || 'ï¼ˆå°šç„¡ä»‹ç´¹ï¼‰'}</div>

    <div class="section-title">æœå‹™é …ç›®</div>
    <div class="muted meta-line">
      ${(r.service || '')}
      ${r.service_contents ? ('<br>'+r.service_contents) : ''}
    </div>

    <div class="section-title">è¯çµ¡è³‡è¨Š</div>
    <div class="muted meta-line">
      ${r.contact ? ('è¯çµ¡äººï¼š'+r.contact+'<br>') : ''}
      ${r.phone ?   ('é›»è©±ï¼š'+r.phone+'<br>') : ''}
      ${r.email ?   ('Emailï¼š'+r.email+'<br>') : ''}
      ${r.line ?    ('Lineï¼š'+r.line+'<br>') : ''}
      ${(!r.contact && !r.phone && !r.email && !r.line) ? 'ï¼ˆå°šç„¡è¯çµ¡è³‡è¨Šï¼‰' : ''}
    </div>

    <div class="section-title">å¯æœå‹™å€åŸŸ</div>
    <div class="muted meta-line">
      ${
        regionFields
          .map(f=>(r[f] && String(r[f]).trim() && !['0','false','n','no',''].includes(String(r[f]).toLowerCase())) ? f : '')
          .filter(Boolean)
          .join('ã€') || 'ï¼ˆå°šæœªæ¨™è¨»ï¼‰'
      }
    </div>

    <div class="section-title">ç¶²ç«™</div>
    <div class="muted meta-line">
      ${r.website ? `<a href="${r.website}" target="_blank">${r.website}</a>` : 'ï¼ˆå°šæœªæä¾›ï¼‰'}
    </div>
  `;
  modal.appendChild(main);

  modalBg.style.display='flex';
  modal.querySelector('.modal-close').addEventListener('click',()=>{ modalBg.style.display='none'; });
}
modalBg.addEventListener('click',e=>{ if(e.target===modalBg) modalBg.style.display='none'; });

/* ========= 8. Filter é‚è¼¯ ========= */

function applyFilters(){
  let res=mainRows.slice();

  const q=(searchInput.value||'').toLowerCase().trim();
  if(q){
    res=res.filter(r=>{
      const hay=((r.name||'')+' '+(r.description||'')+' '+(r.service||'')+' '+(r.service_contents||'')).toLowerCase();
      return hay.includes(q);
    });
  }

  const p=parentSel.value;
  const c=childSel.value;
  if(p){
    res=res.filter(r=>{
      const svc=(r.service||'').toLowerCase();
      if(c) return svc.includes(c.toLowerCase());
      const children=parentMap.get(p)?Array.from(parentMap.get(p)):[];
      if(!children.length) return true;
      return children.some(ch=>svc.includes(ch.toLowerCase()));
    });
  }

  const checkedRegions=Array.from(regionsDiv.querySelectorAll('input[type=checkbox]:checked'))
    .map(i=>i.getAttribute('data-field'));
  if(checkedRegions.length){
    res=res.filter(r=>checkedRegions.every(f=>{
      const v=(r[f]||'').toString().toLowerCase();
      return v && !['0','false','n','no',''].includes(v);
    }));
  }

  const selectedTags=Array.from(tagsSel.selectedOptions).map(o=>o.value.toLowerCase());
  if(selectedTags.length){
    res=res.filter(r=>{
      const hay=((r.tags||'')+' '+(r.service||'')+' '+(r.service_contents||'')).toLowerCase();
      return selectedTags.every(t=>hay.includes(t));
    });
  }

  renderRows(res);
}

/* ========= 9. Events ========= */

applyBtn.addEventListener('click',applyFilters);
resetBtn.addEventListener('click',()=>{
  searchInput.value='';
  parentSel.value='';
  childSel.innerHTML='<option value="">å…¨éƒ¨</option>';
  tagsSel.value='';
  regionsDiv.querySelectorAll('input[type=checkbox]').forEach(i=>i.checked=false);
  renderRows(mainRows);
});
searchInput.addEventListener('keyup',e=>{ if(e.key==='Enter') applyFilters(); });

parentSel.addEventListener('change',()=>{
  const p=parentSel.value;
  childSel.innerHTML='<option value="">å…¨éƒ¨</option>';
  if(!p) return;
  const children=parentMap.get(p)?Array.from(parentMap.get(p)).sort():[];
  children.forEach(c=>{
    const o=document.createElement('option');
    o.value=c; o.textContent=c;
    childSel.appendChild(o);
  });
});

/* ========= 10. è®€å– Google Sheets CSV ========= */

function loadHierarchy(){
  Papa.parse(HIER_CSV_URL,{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:(res)=>{
      const data=res.data||[];
      hierarchy=[];
      data.forEach(row=>{
        const keys=Object.keys(row);
        let parent=''; let children=[];
        keys.forEach(k=>{
          const v=(row[k]||'').toString().trim();
          if(v && !parent) parent=v;
          else if(v) children.push(v);
        });
        if(parent) hierarchy.push({parent,child:children.join(',')});
      });
      hierLoaded=true;
      buildFiltersFromData();
    },
    error:(err)=>{
      console.error('æœå‹™é¡å‹éšå±¤ CSV è®€å–å¤±æ•—ï¼š',err);
    }
  });
}

function loadMain(){
  Papa.parse(MAIN_CSV_URL,{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:(res)=>{
      const raw=res.data||[];
      if(!raw.length){
        countEl.textContent='ä¸»è³‡æ–™ CSV ç‚ºç©º';
        return;
      }
      const headers=Object.keys(raw[0]);
      regionFields=detectRegionFields(headers);

      mainRows=raw.map(row=>{
        const norm=normalizeRow(row);
        headers.forEach(k=>{
          if(regionFields.includes(k)) norm[k]=row[k];
        });
        return norm;
      });

      mainLoaded=true;
      buildFiltersFromData();
      renderRows(mainRows);
    },
    error:(err)=>{
      countEl.textContent='ä¸»è³‡æ–™ CSV è®€å–å¤±æ•—';
      console.error('ä¸»è³‡æ–™ CSV è®€å–å¤±æ•—ï¼š',err);
    }
  });
}

/* åˆå§‹åŒ–ï¼šé€²é é¢å°±è®€å–å…©å€‹ sheet */
loadHierarchy();
loadMain();
</script>
</body>
</html>
